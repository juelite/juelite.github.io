
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>yuuuu.wang`blog</title>
  <meta name="author" content="wang yu">

  
  <meta name="description" content="1/ 选用合适的存储引擎 innoDB与myISAM区别
1. myISAM文件存储为三个文件 .frm（表信息） .MYD（数据） .MYI（索引）而innoDB单文件存储，估计这就是myISAM读性能更好的原因吧
2. myISAM锁为表锁而innoDB为行锁
3. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://juelite.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="yuuuu.wang`blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<!-- <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">-->
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">yuuuu.wang`blog</a></h1>
  
    <h2>power by wang yu</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="juelite.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/26/mysql-optimize-note/">Mysql-optimize-note</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-26T15:17:34+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>3:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>1/ 选用合适的存储引擎</h3>

<pre><code>innoDB与myISAM区别
1. myISAM文件存储为三个文件 .frm（表信息） .MYD（数据） .MYI（索引）而innoDB单文件存储，估计这就是myISAM读性能更好的原因吧
2. myISAM锁为表锁而innoDB为行锁
3. myISAM会存储表数据的行数，而innoDB不会，故 select count(*) form table时myISAM会快于innoDB
4. innoDB支持事务，而myISAM不支持
5. myISAM支持fulltext索引
</code></pre>

<h3>2/ 选用合适的字段属性和适当的宽度以及尽量不使用null</h3>

<pre><code>char与varchar区别，char固定长度，varchar变长 char(10) 存 abc 会占10个字节  而同样的VARCHAR(10)则只占用5(前2个字节存长度)个字节的长
null和""区别，null会占用存储空间 ""不会占存储空间
</code></pre>

<h3>3/ 使用索引</h3>

<pre><code>索引应建立在那些将用于JOIN,WHERE判断和ORDERBY排序的字段上。尽量不要对数据库中某个含有大量重复的值的字段建立索引
</code></pre>

<h3>4/ 优化的查询语句</h3>

<pre><code>1. 最好是在相同类型的字段间进行比较的操作
2. 在建有索引的字段上尽量不要使用函数进行操作
3. 在搜索字符型字段时，我们有时会使用LIKE关键字和通配符，这种做法虽然简单，但却也是以牺牲系统性能为代价的
4. 只取所需字段，尽量不用select *
5. 定期查看慢查询日志
</code></pre>

<h3>5/ 优化mysql配置</h3>

<pre><code>1. key_buffer_size：表示索引缓存的大小。这个值越大，使用索引进行查询的速度就越快
2. table_cache：表示同时打开的表的个数。这个值越大，能同时打开的表的个数就越多。这个值不是越大越好，因为同时打开的表过多会影响操作系统的性能
3. query_cache_size：表示查询缓冲区的大小。使用查询缓存区可以提高查询的速度。这个方式只使用与修改操作少且经常执行相同的查询操作的情况
4. Query_cache_type：表示查询缓存区的开启状态。0表示关闭，1表示开启
5. Max_connections：表示数据库的最大连接数。这个连接数不是越大越好，因为连接会浪费内存的资源
6. Sort_buffer_size：排序缓存区的大小，这个值越大，排序就越快
7. Innodb_buffer_pool_size：表示InnoDB类型的表和索引的最大缓存。这个值越大，查询的速度就会越快。这个值太大了就会影响操作系统的性能
</code></pre>

<h3>6/ 对大表进行拆分</h3>

<pre><code>1. 水平拆分 比如10000条记录分一张表
2. 垂直拆分 比如将新闻信息放在一张表 新闻内容放在另一张表
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/19/laravel-learn-notes/">Laravel_learn_notes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-19T14:05:35+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>1. Eloquent</h2>

<h3>Eloquent 模型约定</h3>

<h4>数据表名称</h4>

<pre><code>```
&lt;?php
    namespace App;
    use Illuminate\Database\Eloquent\Model;
    class Article extends Model
    {
        //
    }
```
</code></pre>

<p>我们并没有告诉 Eloquent Article模型该用哪张数据表，除非数据表明确地指定了其它名称，否则将使用类的「蛇形名称」、复数形式名称来作为数据表的名称 也就是 articles 默认是他使用的表</p>

<p>我们也可以在模型上定义一个 table 属性，用来指定自定义的数据表名称</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 该模型关联数据表
</span><span class='line'> *
</span><span class='line'> * @var string
</span><span class='line'> */
</span><span class='line'>protected $table = 'my_articles' //指定模型关联的数据表</span></code></pre></td></tr></table></div></figure>


<h4>主键</h4>

<p>Eloquent 也会假设每个数据表都有一个叫做 id 的主键字段，我们也可以通过 $primaryKey 属性来重写这个约定</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 该模型关联数据表主键
</span><span class='line'> *
</span><span class='line'> * @var string
</span><span class='line'> */
</span><span class='line'>protected $primaryKey = 'uid';</span></code></pre></td></tr></table></div></figure>


<p>注：Eloquent 假定主键是一个递增的整数值，这意味着在默认情况下主键将自动的被强制转换为 int。 如果我们想使用非递增或者非数字的主键，我们必须在模型 public $incrementing 属性设置为false</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 该模型表主键自增
</span><span class='line'> *
</span><span class='line'> * @var bool
</span><span class='line'> */
</span><span class='line'>public $incrementing = false;</span></code></pre></td></tr></table></div></figure>


<h4>时间戳</h4>

<p>默认情况下，Eloquent 会认为在我们的数据库表有 created_at 和 updated_at 字段，若我们不希望让 Eloquent 来自动维护这两个字段，可在模型内将 $timestamps 属性设置为 false</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 该模型是否被自动维护时间戳
</span><span class='line'> *
</span><span class='line'> * @var bool
</span><span class='line'> */
</span><span class='line'>public $timestamps = false;</span></code></pre></td></tr></table></div></figure>


<h4>数据库连接</h4>

<p>默认情况下，所有的 Eloquent 模型会使用应用程序中默认的数据库连接设置。如果我们想为模型指定不同的连接，可以使用 $connection 属性</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * 此模型的连接名称。
</span><span class='line'> *
</span><span class='line'> * @var string
</span><span class='line'> */
</span><span class='line'>protected $connection = 'connection-name';</span></code></pre></td></tr></table></div></figure>


<h3>查询</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>
</span><span class='line'>    use App\Article;
</span><span class='line'>
</span><span class='line'>    $articles = Article::all();
</span><span class='line'>
</span><span class='line'>    foreach ($flights as $flight) {
</span><span class='line'>        echo $flight-&gt;name;
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>上面实例可以查询与模型关联的数据表数据，一般我们正式开发不可能这样简单的取出数据，我们还有更多的条件：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$articles = Article::where('status', 1)
</span><span class='line'>           -&gt;orderBy('created_at', 'desc')
</span><span class='line'>           -&gt;take(10)
</span><span class='line'>           -&gt;get();</span></code></pre></td></tr></table></div></figure>


<p>更多 Eloquent 查询中使用的方法参见：<a href="https://d.laravel-china.org/docs/5.5/queries#introduction">https://d.laravel-china.org/docs/5.5/queries#introduction</a></p>

<p>类似 all 以及 get 之类的可以取回多个结果的 Eloquent 方法，将会返回一个 Illuminate\Database\Eloquent\Collection 实例， Collection 类提供 多种辅助函数 来处理 Eloquent 结果，参见：<a href="https://d.laravel-china.org/docs/5.5/eloquent-collections#available-methods">https://d.laravel-china.org/docs/5.5/eloquent-collections#available-methods</a></p>

<h2>2.</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/06/laravel-5-dot-4-migrate-error-specified-key-was-too-long-error/">Laravel 5.4 Migrate error:Specified Key Was Too Long Error</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-06T09:52:28+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:52 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Illuminate\Database\QueryException]                                                                                                                                                 
</span><span class='line'>  SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes (SQL: alter table `users` add unique `users_email_unique`(`email`))  
</span><span class='line'>                                                                                                                                                                                       
</span><span class='line'>
</span><span class='line'>                                                                                                                   
</span><span class='line'>  [PDOException]                                                                                                   
</span><span class='line'>  SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes </span></code></pre></td></tr></table></div></figure>


<h3>问题根源</h3>

<p>MySql支持的utf8编码最大字符长度为3字节，如果遇到4字节的宽字符就会出现插入异常。三个字节UTF-8最大能编码的Unicode字符是0xffff，即Unicode中的基本多文种平面（BMP）。因而包括Emoji表情（Emoji是一种特殊的Unicode编码）在内的非基本多文种平面的Unicode字符都无法使用MySql的utf8字符集存储。</p>

<p>这也应该就是Laravel 5.4改用4字节长度的utf8mb4字符编码的原因之一。不过要注意的是，只有MySql 5.5.3版本以后才开始支持utf8mb4字符编码（查看版本：selection version();）。如果MySql版本过低，需要进行版本更新。</p>

<p>注：如果是从Laravel 5.3升级到Laravel 5.4，不需要对字符编码做切换。</p>

<h3>解决问题</h3>

<p>1.升级MySql版本到5.5.3以上。
2.手动配置迁移命令migrate生成的默认字符串长度，在AppServiceProvider中调用Schema::defaultStringLength方法来实现配置：
文件位置：/Users/wy/Documents/www/news.local.com/app/Providers/AppServiceProvider.php</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>use Illuminate\Support\Facades\Schema;
</span><span class='line'>
</span><span class='line'>/**
</span><span class='line'>* Bootstrap any application services.
</span><span class='line'>*
</span><span class='line'>* @return void
</span><span class='line'>*/
</span><span class='line'>public function boot()
</span><span class='line'>{
</span><span class='line'>   Schema::defaultStringLength(191);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/29/golang-printf-type/">Golang Printf Type</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-29T16:04:14+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><table>
<thead>
<tr>
<th style="text-align:center;">符号 </th>
<th style="text-align:left;"> 注释 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;">%d          </td>
<td style="text-align:left;">int变量</td>
</tr>
<tr>
<td style="text-align:center;">%x, %o, %b  </td>
<td style="text-align:left;">分别为16进制，8进制，2进制形式的int</td>
</tr>
<tr>
<td style="text-align:center;">%f, %g, %e  </td>
<td style="text-align:left;">浮点数： 3.141593 3.141592653589793 3.141593e+00</td>
</tr>
<tr>
<td style="text-align:center;">%t          </td>
<td style="text-align:left;">布尔变量：true 或 false</td>
</tr>
<tr>
<td style="text-align:center;">%c          </td>
<td style="text-align:left;">rune (Unicode码点)，Go语言里特有的Unicode字符类型</td>
</tr>
<tr>
<td style="text-align:center;">%s          </td>
<td style="text-align:left;">string</td>
</tr>
<tr>
<td style="text-align:center;">%q          </td>
<td style="text-align:left;">带双引号的字符串 &ldquo;abc&rdquo; 或 带单引号的 rune &lsquo;c&rsquo;</td>
</tr>
<tr>
<td style="text-align:center;">%v          </td>
<td style="text-align:left;">会将任意变量以易读的形式打印出来</td>
</tr>
<tr>
<td style="text-align:center;">%T          </td>
<td style="text-align:left;">打印变量的类型</td>
</tr>
<tr>
<td style="text-align:center;">%%          </td>
<td style="text-align:left;">字符型百分比标志（%符号本身，没有其他操作）</td>
</tr>
</tbody>
</table>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/21/qianghongbao-jiandanshixian/">微信抢红包实现</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-21T17:29:38+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>5:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>简单流程</h3>

<p><img src="/images/WX20170821-173238@2x.png" alt="understand-mysql-charset" /></p>

<h3>红包何时拆？</h3>

<ol>
<li>发起者点击发送后，预先拆好红包</li>
<li>由抢红包用户触发，抢一个计算一个金额</li>
</ol>


<p>如果由用户来触发拆红包，当拆红包请求达到一个量级的时候，可能会对服务器造成比较大的压力，所以我们在发起者发送完红包后直接计算好红包分数及对应的金额，用户抢红包请求到达，直接赋值，无需计算</p>

<h2>#</h2>

<p>发起红包时拆分，将红包拆分好入栈，简单递归下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$count = 3; //3个红包
</span><span class='line'>
</span><span class='line'>$sum = 100; //100元
</span><span class='line'>
</span><span class='line'>$current = array();
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>function do_split($sum , $cnt){
</span><span class='line'>    global $current;
</span><span class='line'>    if($cnt === 1){
</span><span class='line'>        $current[] = $sum;
</span><span class='line'>    }else{
</span><span class='line'>        $ld = 0.01;
</span><span class='line'>        $total = $sum / $ld;
</span><span class='line'>        $max = round($total / $cnt);
</span><span class='line'>        $min = 1;
</span><span class='line'>        $currWhide = rand($min , 2 * $max);
</span><span class='line'>        $current[] = $jqje = $currWhide * $ld;
</span><span class='line'>        $syje = $sum - $jqje;
</span><span class='line'>        do_split( $syje , $cnt - 1);
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>do_split($sum , $count);
</span><span class='line'>
</span><span class='line'>var_dump($current);
</span><span class='line'>
</span><span class='line'>foreach ($current as $key =&gt; $value) {
</span><span class='line'>    $redis-&gt;lpush('hongbao1',$value);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>用户抢红包</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$uid = $_GET['uid'];
</span><span class='line'>$je = $redis-&gt;lpop('hongbao1');
</span><span class='line'>if($je &gt; 0){
</span><span class='line'>    echo '恭喜'.$uid.'您抢到'.$je.'元';
</span><span class='line'>}else{
</span><span class='line'>    echo $uid.'您的手也太慢了吧！';
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>项目地址：<a href="https://github.com/juelite/qianghongbao">https://github.com/juelite/qianghongbao</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/05/07/windows-xia-ffmpegshi-yong/">Ffmpeg使用</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-05-07T18:14:09+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>6:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>列出设备</p>

<pre><code>/usr/local/bin/ffmpeg -list_devices true -f dshow -i dummy  
</code></pre>

<p>保存文件</p>

<pre><code>/usr/local/bin/ffmpeg -f dshow -i video="Integrated Camera" -vcodec libx264 mycamera.mkv  
</code></pre>

<p>直接播放</p>

<pre><code>/usr/local/bin/ffplay -f dshow -i video="Integrated Camera"  
</code></pre>

<p>推流</p>

<pre><code>/usr/local/bin/ffmpeg -f dshow -i video="Integrated Camera" -vcodec libx264 -preset:v ultrafast -tune:v zerolatency -f flv rtmp://192.168.1.5/mytv/test1
</code></pre>

<p>录制屏幕</p>

<pre><code>/usr/local/bin/ffmpeg -f x11grab -s 1600x900 -r 50 -vcodec libx264 –preset:v ultrafast –tune:v zerolatency -crf 18 -f mpegts rtmp://192.168.1.5/mytv/test2      在Windows平台下，使用-dshow取代x11grab
</code></pre>

<p>抽帧存图</p>

<p>/usr/local/bin/ffmpeg -i aa.mp4 -vframes 128 -r 1 -q:v 2 -f image2 -ss 90 ~/Downloads/image-1.jpeg;</p>

<p>PHP结合ffmpeg获取视频/音频文件信息</p>

<pre><code>$command = sprintf(FFMPEG_PATH, $file);

ob_start();
passthru($command);
$info = ob_get_contents();
ob_end_clean();

$data = array();
if (preg_match("/Duration: (.*?), start: (.*?), bitrate: (\d*) kb\/s/", $info, $match)) {
    $data['duration'] = $match[1]; //播放时间
    $arr_duration = explode(':', $match[1]);
    $data['seconds'] = $arr_duration[0] * 3600 + $arr_duration[1] * 60 + $arr_duration[2]; //转换播放时间为秒数
    $data['start'] = $match[2]; //开始时间
    $data['bitrate'] = $match[3]; //码率(kb)
}
if (preg_match("/Video: (.*?), (.*?), (.*?)[,\s]/", $info, $match)) {
    $data['vcodec'] = $match[1]; //视频编码格式
    $data['vformat'] = $match[2]; //视频格式
    $data['resolution'] = $match[3]; //视频分辨率
    $arr_resolution = explode('x', $match[3]);
    $data['width'] = $arr_resolution[0];
    $data['height'] = $arr_resolution[1];
}
if (preg_match("/Audio: (\w*), (\d*) Hz/", $info, $match)) {
    $data['acodec'] = $match[1]; //音频编码
    $data['asamplerate'] = $match[2]; //音频采样频率
}
if (isset($data['seconds']) &amp;&amp; isset($data['start'])) {
    $data['play_time'] = $data['seconds'] + $data['start']; //实际播放时间
}
$data['size'] = filesize($file); //文件大小
return $data;
</code></pre>

<p>-i 指定输入的文件
-acodec 指定输出文件的音频编码
-vcodec 指定输出文件的视频编码</p>

<p>最简单的抓屏：</p>

<pre><code>/usr/local/bin/ffmpeg -f gdigrab -i desktop out.mpg
</code></pre>

<p>从屏幕的（10,20）点处开始，抓取640x480的屏幕，设定帧率为5</p>

<pre><code>/usr/local/bin/ffmpeg -f gdigrab -framerate 5 -offset_x 10 -offset_y 20 -video_size 640x480 -i desktop out.mpg
</code></pre>

<p>//=======================================================================
    /usr/local/bin/ffmpeg -ss START -t DURATION -i INPUT -vcodec copy -acodec copy OUTPUT
    对上面的命令稍做个解释。
    -ss 开始时间，如： 00:00:20，表示从20秒开始；
    -t 时长，如： 00:00:10，表示截取10秒长的视频；
    -i 输入，后面是空格，紧跟着就是输入视频文件；
    -vcodec copy 和 -acodec copy表示所要使用的视频和音频的编码格式，这里指定为copy表示原样拷贝；
    INPUT，输入视频文件；
    OUTPUT，输出视频文件；
//=======================================================================</p>

<pre><code>/usr/local/bin/ffmpeg -f x11grab -s xga -r 10 -i :0.0+0+0 wheer.avi
-i video="screen-capture-recorder"

/usr/local/bin/ffmpeg -f dshow -i video="DirectShow video devices" -f dshow -i audio="DirectShow audio devices" -pix_fmt yuv420p -vcodec libx264 -acodec libvo_aacenc -s 1280x720 -r 25 -q 10 -ar 44100 -ac 2 -tune zerolatency -preset ultrafast -f mpegts - | ffmpeg -f mpegts -i - -c copy -bsf:a aac_adtstoasc -f flv temp.flv
</code></pre>

<p>-r选项设置每秒提取图片的帧数。
-q:v 2  设置输出文件的视频质量为：优</p>

<p>截取一张352x240尺寸大小的，格式为jpg的图片</p>

<pre><code>/usr/local/bin/ffmpeg -i 1.mp4 -y -f image2 -t 120.001 -s 352x240 a.jpg
</code></pre>

<p>把视频的前30帧转换成一个Animated Gif ：</p>

<pre><code>/usr/local/bin/ffmpeg -i 1.mp4 -vframes 30 -y -f gif a.gif
</code></pre>

<p>生成缩略图</p>

<pre><code>/usr/local/bin/ffmpeg -i 1.mp4 -y -f image2 -ss 08.010 -t 0.001 -s 352x240 b.jpg
</code></pre>

<p>列出本机设备</p>

<pre><code>/usr/local/bin/ffmpeg -list_devices true -f dshow -i dummy
</code></pre>

<p>从视频中生成gif图片</p>

<pre><code>/usr/local/bin/ffmpeg -i 1.mp4 -ss 10 -t 10   -s 480x360  tutu.gif
</code></pre>

<h2>-ss 指从 10s 开始转码,-t 指转换 10s 的视频 -s 指定尺寸</h2>

<pre><code>rtmp://video-center.alivecdn.com/AppName/StreamName?vhost=zhibo.busionline.com
</code></pre>

<p>前言：FFmpeg是做音视频开发的一个优秀的开源库，可以在不同平台下编译，能够实现视频采集、视频格式转化、视频截图、视频添加水印、视频切片、视频录制、视频推流、更改音视频参数功能等。通过终端命令及开发时如何实现这些功能，本文做一整理记录，以备不时之需。下面共四组命令。</p>

<p>第一组</p>

<p>1.分离视频音频流</p>

<pre><code>/usr/local/bin/ffmpeg -i input_file -vcodec copy -an output_file_video　　//分离视频流ffmpeg -i input_file -acodec copy -vn output_file_audio　　//分离音频流
</code></pre>

<p>2.视频解复用</p>

<pre><code>/usr/local/bin/ffmpeg –i test.mp4 –vcodec copy –an –f m4v test.264

/usr/local/bin/ffmpeg –i test.avi –vcodec copy –an –f m4v test.264
</code></pre>

<p>3.视频转码</p>

<pre><code>/usr/local/bin/ffmpeg –i test.mp4 –vcodec h264 –s 352*278 –an –f m4v test.264
</code></pre>

<p>//转码为码流原始文件</p>

<pre><code>/usr/local/bin/ffmpeg –i test.mp4 –vcodec h264 –bf 0 –g 25 –s 352*278 –an –f m4v test.264 //转码为码流原始文件

/usr/local/bin/ffmpeg –i test.avi -vcodec mpeg4 –vtag xvid –qsame test_xvid.avi //转码为封装文件
</code></pre>

<p>说明：-bf B帧数目控制，-g 关键帧间隔控制，-s 分辨率控制</p>

<p>4.视频封装</p>

<pre><code>/usr/local/bin/ffmpeg –i video_file –i audio_file –vcodec copy –acodec copy output_file
</code></pre>

<p>5.视频剪切</p>

<pre><code>/usr/local/bin/ffmpeg –i test.avi –r 1 –f image2 image-%3d.jpeg //提取图片

/usr/local/bin/ffmpeg -ss 0:1:30 -t 0:0:20 -i input.avi -vcodec copy -acodec copy output.avi //剪切视频//-r 提取图像的频率，-ss 开始时间，-t 持续时间
</code></pre>

<p>6.视频录制</p>

<pre><code>/usr/local/bin/ffmpeg –i rtsp://192.168.3.205:5555/test –vcodec copy out.avi
</code></pre>

<p>7、利用ffmpeg视频切片</p>

<p>主要把视频源切成若干个.ts格式的视频片段然后生成一个.m3u8的切片文件索引提供给html5的video做hls直播源</p>

<p>命令如下：</p>

<pre><code>/usr/local/bin/ffmpeg -i 视频源地址 -strict -2 -c:v libx264 -c:a aac -f hls m3u8文件输出地址
</code></pre>

<p>8、ffmpeg缩放视频</p>

<p>假设原始视频尺寸是 1080p（即 1920×1080 px，16:9），使用下面命令可以缩小到 480p：(ps:以下这个命令，据说违反微信平台相关法律，蛋疼，用不了文字，只能用图片了)</p>

<p>各个参数的含义：-i a.mov 指定待处理视频的文件名-vf scale=853:480 vf 参数用于指定视频滤镜，其中 scale 表示缩放，后面的数字表示缩放至 853×480 px，其中的 853px 是计算而得，因为原始视频的宽高比为 16:9，所以为了让目标视频的高度为 480px，则宽度 = 480 x 9 / 16 = 853-acodec aac 指定音频使用 aac 编码。注：因为 ffmpeg 的内置 aac 编码目前还是试验阶段，故会提示添加参数 “-strict -2” 才能继续，尽管添加即可。又或者使用外部的 libfaac（需要重新编译 ffmpeg）。-vcodec h264 指定视频使用 h264 编码。注：目前手机一般视频拍摄的格式（封装格式、文件格式）为 mov 或者 mp4，这两者的音频编码都是 aac，视频都是 h264。out.mp4 指定输出文件名上面的参数 scale=853:480 当中的宽度和高度实际应用场景中通常只需指定一个，比如指定高度为 480 或者 720，至于宽度则可以传入 “-1” 表示由原始视频的宽高比自动计算而得。即参数可以写为：scale=-1:480，当然也可以 scale=480:-1</p>

<p>9、ffmpeg裁剪</p>

<p>有时可能只需要视频的正中一块，而两头的内容不需要，这时可以对视频进行裁剪（crop），比如有一个竖向的视频 1080 x 1920，如果指向保留中间 1080×1080 部分命令如下：ffmpeg -i 视频源地址 -strict -2 -vf crop=1080:1080:0:420 视频输出地址（如：out.mp4）</p>

<p>其中的 crop=1080:1080:0:420 才裁剪参数，具体含义是 crop=width:height:x:y，其中 width 和 height 表示裁剪后的尺寸，x:y 表示裁剪区域的左上角坐标。比如当前这个示例，我们只需要保留竖向视频的中间部分，所以 x 不用偏移，故传入0，而 y 则需要向下偏移：(1920 – 1080) / 2 = 420</p>

<ol>
<li><p>转视频格式</p>

<p>/usr/local/bin/ffmpeg -i source.mp4 -c:v libx264 -crf 24 destination.flv</p></li>
</ol>


<p>其中 -crf 很重要，是控制转码后视频的质量，质量越高，文件也就越大。</p>

<p>此值的范围是 0 到 51：0 表示高清无损；23 是默认值（如果没有指定此参数）；51 虽然文件最小，但效果是最差的。</p>

<p>值越小，质量越高，但文件也越大，建议的值范围是 18 到 28。而值 18 是视觉上看起来无损或接近无损的，当然不代表是数据（技术上）的转码无损。</p>

<p>第二组</p>

<p>1.ffmpeg 把文件当做直播推送至服务器 (RTMP + FLV)</p>

<pre><code>/usr/local/bin/ffmpeg - re -i demo.mp4 -c copy - f flv rtmp://w.gslb.letv/live/streamid
</code></pre>

<p>2.将直播的媒体保存到本地</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://r.glsb.letv/live/streamid -c copy streamfile.flv
</code></pre>

<p>3.将一个直播流，视频改用h264压缩，音频改用faac压缩，送至另一个直播服务器</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://r.glsb.letv/live/streamidA -c:a libfaac -ar 44100 -ab 48k -c:v libx264 -vpre slow -vpre baseline -f flv rtmp://w.glsb.letv/live/streamb
</code></pre>

<p>4.提取视频中的音频,并保存为mp3 然后输出</p>

<pre><code>/usr/local/bin/ffmpeg -i input.avi -b:a 128k output.mp3
</code></pre>

<ol>
<li><p>将mp3转为pcm</p>

<p> ffmpeg-iinput.mp3-fs16be-acodecpcm_s16beoutput.pcm</p></li>
</ol>


<p>第三组</p>

<p>1.获取视频的信息</p>

<pre><code>/usr/local/bin/ffmpeg -i video.avi
</code></pre>

<p>2.将图片序列合成视频</p>

<pre><code>/usr/local/bin/ffmpeg -f image2 -i image%d.jpg video.mpg
</code></pre>

<p>上面的命令会把当前目录下的图片（名字如：image1.jpg. image2.jpg. 等&hellip;）合并成video.mpg</p>

<p>3.将视频分解成图片序列</p>

<pre><code>/usr/local/bin/ffmpeg -i video.mpg image%d.jpg
</code></pre>

<p>上面的命令会生成image1.jpg. image2.jpg. &hellip;</p>

<pre><code>支持的图片格式有：PGM. PPM. PAM. PGMYUV. JPEG. GIF. PNG. TIFF. SGI
</code></pre>

<p>4.为视频重新编码以适合在iPod/iPhone上播放</p>

<pre><code>/usr/local/bin/ffmpeg -i source_video.avi input -acodec aac -ab 128kb -vcodec mpeg4 -b 1200kb -mbd 2 -flags +4mv+trell -aic 2 -cmp 2 -subcmp 2 -s 320x180 -title X final_video.mp4
</code></pre>

<p>5.为视频重新编码以适合在PSP上播放</p>

<pre><code>/usr/local/bin/ffmpeg -i source_video.avi -b 300 -s 320x240 -vcodec xvid -ab 32 -ar 24000 -acodec aac final_video.mp4
</code></pre>

<p>6.从视频抽出声音.并存为Mp3</p>

<pre><code>/usr/local/bin/ffmpeg -i source_video.avi -vn -ar 44100 -ac 2 -ab 192 -f mp3 sound.mp3
</code></pre>

<p>7.将wav文件转成Mp3</p>

<pre><code>/usr/local/bin/ffmpeg -i son_origine.avi -vn -ar 44100 -ac 2 -ab 192 -f mp3 son_final.mp3
</code></pre>

<p>8.将.avi视频转成.mpg</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi video_finale.mpg
</code></pre>

<p>9.将.mpg转成.avi</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.mpg video_finale.avi
</code></pre>

<p>10.将.avi转成gif动画（未压缩）</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi gif_anime.gif
</code></pre>

<p>11.合成视频和音频</p>

<pre><code>/usr/local/bin/ffmpeg -i son.wav -i video_origine.avi video_finale.mpg
</code></pre>

<p>12.将.avi转成.flv</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -ab 56 -ar 44100 -b 200 -r 15 -s 320x240 -f flv video_finale.flv
</code></pre>

<p>13.将.avi转成dv</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -s pal -r pal -aspect 4:3 -ar 48000 -ac 2 video_finale.dv
</code></pre>

<p>或者：</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -target pal-dv video_finale.dv
</code></pre>

<p>14.将.avi压缩成divx</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -s 320x240 -vcodec msmpeg4v2 video_finale.avi
</code></pre>

<p>15.将Ogg Theora压缩成Mpeg dvd</p>

<pre><code>/usr/local/bin/ffmpeg -i film_sortie_cinelerra.ogm -s 720x576 -vcodec mpeg2video -acodec mp3 film_terminate.mpg
</code></pre>

<p>16.将.avi压缩成SVCD mpeg2</p>

<p>NTSC格式：</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -target ntsc-svcd video_finale.mpg
</code></pre>

<p>PAL格式：</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -target pal-dvcd video_finale.mpg
</code></pre>

<p>17.将.avi压缩成VCD mpeg2</p>

<pre><code>NTSC格式： 
/usr/local/bin/ffmpeg -i video_origine.avi -target ntsc-vcd video_finale.mpg
</code></pre>

<p>PAL格式：</p>

<pre><code>/usr/local/bin/ffmpeg -i video_origine.avi -target pal-vcd video_finale.mpg
</code></pre>

<p>18.多通道编码</p>

<pre><code>/usr/local/bin/ffmpeg -i fichierentree -pass 2 -passlogfile ffmpeg2pass fichiersortie-2
</code></pre>

<p>19.从flv提取mp3</p>

<pre><code>/usr/local/bin/ffmpeg -i source.flv -ab 128k dest.mp3
</code></pre>

<p>第四组</p>

<p>1、将文件当做直播送至live</p>

<pre><code>/usr/local/bin/ffmpeg -re -i localFile.mp4 -c copy -f flv rtmp://server/live/streamName
</code></pre>

<p>2、将直播媒体保存至本地文件</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://server/live/streamName -c copy dump.flv
</code></pre>

<p>3、将其中一个直播流，视频改用h264压缩，音频不变，送至另外一个直播服务流</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://server/live/originalStream -c:a copy -c:v libx264 -vpre slow -f flv rtmp://server/live/h264Stream
</code></pre>

<p>4、将其中一个直播流，视频改用h264压缩，音频改用faac压缩，送至另外一个直播服务流</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://server/live/originalStream -c:a libfaac -ar 44100 -ab 48k -c:v libx264 -vpre slow -vpre baseline -f flv rtmp://server/live/h264Stream
</code></pre>

<p>5、将其中一个直播流，视频不变，音频改用faac压缩，送至另外一个直播服务流</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://server/live/originalStream -acodec libfaac -ar 44100 -ab 48k -vcodec copy -f flv rtmp://server/live/h264_AAC_Stream
</code></pre>

<p>6、将一个高清流，复制为几个不同视频清晰度的流重新发布，其中音频不变</p>

<pre><code>/usr/local/bin/ffmpeg -re -i rtmp://server/live/high_FMLE_stream -acodec copy -vcodec x264lib -s 640×360 -b 500k -vpre medium -vpre baseline rtmp://server/live/baseline_500k -acodec copy -vcodec x264lib -s 480×272 -b 300k -vpre medium -vpre baseline rtmp://server/live/baseline_300k -acodec copy -vcodec x264lib -s 320×200 -b 150k -vpre medium -vpre baseline rtmp://server/live/baseline_150k -acodec libfaac -vn -ab 48k rtmp://server/live/audio_only_AAC_48k
</code></pre>

<p>7、功能一样，只是采用-x264opts选项</p>

<pre><code>/usr/local/bin/ffmpeg -re -i rtmp://server/live/high_FMLE_stream -c:a copy -c:v x264lib -s 640×360 -x264opts bitrate=500:profile=baseline:preset=slow rtmp://server/live/baseline_500k -c:a copy -c:v x264lib -s 480×272 -x264opts bitrate=300:profile=baseline:preset=slow rtmp://server/live/baseline_300k -c:a copy -c:v x264lib -s 320×200 -x264opts bitrate=150:profile=baseline:preset=slow rtmp://server/live/baseline_150k -c:a libfaac -vn -b:a 48k rtmp://server/live/audio_only_AAC_48k
</code></pre>

<p>8、将当前摄像头及音频通过DSSHOW采集，视频h264、音频faac压缩后发布</p>

<pre><code>/usr/local/bin/ffmpeg -r 25 -f dshow -s 640×480 -i video=”video source name”:audio=”audio source name” -vcodec libx264 -b 600k -vpre slow -acodec libfaac -ab 128k -f flv rtmp://server/application/stream_name
</code></pre>

<p>9、将一个JPG图片经过h264压缩循环输出为mp4视频</p>

<pre><code>/usr/local/bin/ffmpeg -i INPUT.jpg -an -vcodec libx264 -coder 1 -flags +loop -cmp +chroma -subq 10 -qcomp 0.6 -qmin 10 -qmax 51 -qdiff 4 -flags2 +dct8x8 -trellis 2 -partitions +parti8x8+parti4x4 -crf 24 -threads 0 -r 25 -g 25 -y OUTPUT.mp4
</code></pre>

<p>10、将普通流视频改用h264压缩，音频不变，送至高清流服务(新版本FMS live=1)</p>

<pre><code>/usr/local/bin/ffmpeg -i rtmp://server/live/originalStream -c:a copy -c:v libx264 -vpre slow -f flv “rtmp://server/live/h264Stream live=1〃
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/11/gperftools-profile-nginx-mysql-memory/">Gperftools优化nginx和mysql的内存分配</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-11T12:23:38+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h6>###########  Google 开发的 gperftools 包含四个工具，分别是：TCMalloc、heap-checker、heap-profiler 和 cpu-profiler</h6>

<h6>###########  TCMalloc是 gperftools 的其中一个工具，用于优化C++写的多线程应用，与标准的glibc库的malloc相比，TCMalloc在内存的分配效率和速度要高，可以在高并发的情况下很好的控制内存的使用，提高服务器的性能，降低负载。</h6>

<h6>###########  使用 TCMalloc 优化 Nginx 和 MySQL 的内存管理，性能将会有一定程度的提升，特别是对MYSQL服务器高并发下情况下的性能。</h6>

<h6>###########  安装 libunwind 库</h6>

<h6>###########  如果系统是64位的需要先安装libunwind库，32位系统则不需要安装。</h6>

<h6>###########  libunwind 库为基于64位CPU和操作系统的程序提供了基本的堆栈辗转开解功能，其中包括用于输出堆栈跟踪的API、用于以编程方式辗转开解堆栈的API以及支持C++异常处理机制的API。</h6>

<p>wget <a href="http://download.savannah.gnu.org/releases/libunwind/libunwind-1.0.1.tar.gz">http://download.savannah.gnu.org/releases/libunwind/libunwind-1.0.1.tar.gz</a>
tar -zxvf libunwind-1.0.1.tar.gz
cd libunwind-1.0.1/
CFLAGS=-fPIC ./configure
make CFLAGS=-fPIC
make CFLAGS=-fPIC install
cd ../</p>

<h6>###########  gperftools 的安装</h6>

<h6>###########  gperftools 项目网站 <a href="http://code.google.com/p/gperftools/">http://code.google.com/p/gperftools/</a></h6>

<p>wget <a href="http://gperftools.googlecode.com/files/gperftools-2.0.tar.gz">http://gperftools.googlecode.com/files/gperftools-2.0.tar.gz</a>
tar -zxvf gperftools-2.0.tar.gz
cd gperftools-2.0
./configure &ndash;prefix=/usr/local &ndash;enable-frame-pointers
make
make install
cd ../</p>

<h6>###########  如果是32位系统,可以不添加 –enable-frame-pointers</h6>

<h6>###########  如果是64位系统，并且之前没有安装libunwind，那么一定要添加 –enable-frame-pointers 参数。</h6>

<p>echo &ldquo;/usr/local/lib&rdquo; > /etc/ld.so.conf.d/usr_local_lib.conf
/sbin/ldconfig</p>

<h6>###########  为 gperftools 添加线程目录:</h6>

<p>mkdir /tmp/tcmalloc
chmod 0777 /tmp/tcmalloc</p>

<h6>###########  使用gperftools优化Nginx：</h6>

<h6>###########  为了使 Nginx 支持 gperftools，增加参数 –with-google_perftools_module 重新编译Nginx。</h6>

<h6>###########  修改/usr/local/nginx/conf/nginx.conf</h6>

<h6>###########  在pid这行的下面添加</h6>

<p>google_perftools_profiles /tmp/tcmalloc;</p>

<h6>###########  重新启动nginx</h6>

<h6>###########  使用gperftools优化MYSQL：</h6>

<h6>###########  查找文件 /usr/local/mysql/bin/mysqld_safe</h6>

<h6>###########  在# executing mysqld_safe 下面加上</h6>

<p>export LD_PRELOAD=/usr/local/lib/libtcmalloc.so</p>

<h6>###########  重新启动MYSQL</h6>

<h6>###########  验证 tcmalloc 是否运行：</h6>

<p>lsof -n | grep tcmalloc</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/06/htop/">Htop是个好东西</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-06T13:49:16+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre><code>Htop是一款运行于Linux系统监控与进程管理软件，用于取代Unix下传统的top。与top只提供最消耗资源的进程列表不同，htop提供所有进程的列表，并且使用彩色标识出处理器、swap和内存状态。
</code></pre>

<p>用户一般可以在top无法提供详尽系统信息的情况下选择安装并使用htop。比如，在查找应用程序的内存泄漏问题时。与top相比，htop提供更方便、光标控制的界面来杀死进程。
htop用C语言编写，采用了ncurses库。htop的名称源于其作者的名字。</p>

<h2>安装-htop</h2>

<pre><code>yum -y install ncurses-devel #htop依赖ncurses
cd /opt
wget -c http://ncu.dl.sourceforge.net/project/htop/htop/1.0.2/htop-1.0.2.tar.gz
tar xzf htop-1.0.2.tar.gz
cd htop-1.0.2
./configure
make &amp;&amp; make install
</code></pre>

<h2>示例图片</h2>

<p><img src="/images/2015/htop.gif" title="示例图片" alt="示例图片" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/19/css-clearfix/">Css-clearfix</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-19T11:20:41+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:20 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre><code>&lt;style&gt;
.clearfix:after{
    visibility: hidden;
    display: block;
    font-size: 0;
    content: ".";
    clear: both;
    height: 0;
}

* html .clearfix{zoom: 1;}
*:first-child + html .clearfix{zoom: 1;}
&lt;/style&gt;
&lt;div class="clearfix" style="border: 2px solid red;"&gt;
    &lt;div style="float: left; width: 80px; height: 80px; border: 1px solid blue;"&gt;TEST DIV&lt;/div&gt;
&lt;/div&gt;
</code></pre>

<h3>说明：</h3>

<ol>
<li>首先是利用:after这个伪类来兼容FF、Chrome等支持标准的浏览器。:after伪类IE不支持，它用来和content属性一起使用设置在对象后的内容，例如：a:after{content:&ldquo;(link)&rdquo;;}这个CSS将会让a标签内的文本后边加上link文本文字。</li>
<li>利用“* html”这个只有IE6认识的选择符，设置缩放属性“zoom: 1;”实现兼容IE6。</li>
<li>利用“*:first-child + html”这个只有IE7认识的选择符，设置缩放属性“zoom: 1;”实现兼容IE7。</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/19/mysql-shell-prompt-metachar/">MySQL 的 Prompt 转义字符</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-10-19T10:53:38+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:53 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><pre><code>```
\c    ：A counter that increments for each statement you issue
\D    ：The full current date
\d    ：The default database
\h    ：The server host
\l    ：The current delimiter (new in 5.1.12)
\m    ：Minutes of the current time
\n    ：A newline character
\O    ：The current month in three-letter format (Jan, Feb, …)
\o    ：The current month in numeric format
\P    ：am/pm
\p    ：The current TCP/IP port or socket file
\R    ：The current time, in 24-hour military time (0–23)
\r    ：The current time, standard 12-hour time (1–12)
\S    ：Semicolon
\s    ：Seconds of the current time
\t    ：A tab character
\U    ：Your full user_name@host_name account name
\u    ：Your user name
\v    ：The server version
\w    ：The current day of the week in three-letter format (Mon, Tue, …)
\Y    ：The current year, four digits
\y    ：The current year, two digits
\_    ：A space
\A    ：space (a space follows the backslash)
\'    ：Single quote
\"    ：Double quote
\\    ：A literal “\” backslash character
\x    ：x, for any “x” not listed above
```
</code></pre>

<p>用法实例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql -uroot -p --prompt="\\u@\\h:\\d \\r:\\m:\\s&gt;"</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/WX20170911-173112@2x.png" alt="understand-mysql-charset" /></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/09/26/mysql-optimize-note/">Mysql-optimize-note</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/19/laravel-learn-notes/">Laravel_learn_notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/06/laravel-5-dot-4-migrate-error-specified-key-was-too-long-error/">Laravel 5.4 Migrate error:Specified Key Was Too Long Error</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/29/golang-printf-type/">Golang Printf Type</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/21/qianghongbao-jiandanshixian/">微信抢红包实现</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - wang yu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
